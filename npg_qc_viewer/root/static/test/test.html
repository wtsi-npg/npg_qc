<!DOCTYPE html>
<html>
<head>
<title>QUnit Test Suite</title>
<link rel="stylesheet" href="../bower_components/qunit/qunit/qunit.css" type="text/css" media="screen">
<script type="text/javascript" src="../bower_components/qunit/qunit/qunit.js"></script>
<script type="text/javascript" src="../bower_components/jquery/jquery.js"></script>
<script type="text/javascript" src="../bower_components/blanket/dist/qunit/blanket.js"></script>
<!-- Your project file goes here -->
<script type="text/javascript" src="../scripts/manual_qc.js" data-cover></script>
<script type="text/javascript" src="../scripts/manual_qc_ui.js" data-cover></script>
<!-- Your tests file goes here -->
<script type="text/javascript" src="test.js"></script>
<script>
  QUnit.test("DOM linking", function( assert ) {
    var lane = $("#mqc_lane1");
    assert.notEqual(lane, undefined, "mqc_lane is an instance.");
    assert.equal(lane.data('id_run'), '2', "id_run is 2.");
    assert.equal(lane.data('position'), '3', "position is 3.");
    assert.equal(lane.data('initial'), undefined, "No initial value.");
    var control = new NPG.QC.LaneMQCControl(new TestConfiguration());
    assert.notEqual(control, undefined, "Control is an instance.");
    control.linkControl(lane);
    assert.notEqual(control.lane_control, undefined, "lane_control in Control is linked.");
    assert.equal(control.lane_control, lane, "Control and lane are correctly linked.");
    assert.equal(control.lane_control.outcome, undefined, "Outcome of lane is not defined.");
  });
  
  QUnit.test("DOM linking lane with previous status", function( assert ) {
    var lane = $("#mqc_lane2");
    assert.notEqual(lane, undefined, "mqc_lane is an instance.");
    assert.equal(lane.data('id_run'), '3', "id_run is 3.");
    assert.equal(lane.data('position'), '4', "position is 4.");
    assert.notEqual(lane.data('initial'), undefined, "Has initial value.");
    assert.equal(lane.data('initial'), 'Accepted final', "Initial value as expected.");
    var control = new NPG.QC.LaneMQCControl(new TestConfiguration());
    assert.notEqual(control, undefined, "Control is an instance.");
    control.linkControl(lane);
    assert.notEqual(control.lane_control, undefined, "lane_control in Control is linked.");
  });
  
  QUnit.test("NPG.QC.RunTitleParser.parseRunId()", function(assert) {
    var parser = new NPG.QC.RunTitleParser();
    assert.throws(function() {parser.parseIdRun();}, /Error: Invalid arguments/, "Validates non-empty arguments");
    assert.throws(function() {parser.parseIdRun(null);}, /Error: Invalid arguments/, "Validates null argument");
    var title1 = parser.parseIdRun('');
    assert.equal(title1, null, 'Can deal with empty string.');
    var title2 = parser.parseIdRun('Bla bla bla');
    assert.equal(title2, null, 'Can deal with random string');
    var title3 = parser.parseIdRun('NPG SeqQC v56.7: Results for run number (current run status: qc in progress, taken by user)');
    assert.equal(title3, null, 'Can deal with non valid run_id (lexical validation)');
    var title4 = parser.parseIdRun('NPG SeqQC v56.7: Results for run (current run status: qc in progress, taken by user)');
    assert.equal(title4, null, 'Can deal with missing run_id (lexical validation)');
    var title5 = parser.parseIdRun('NPG SeqQC v56.7: Results for run 16074 (current run status: qc in progress, taken by user)');
    assert.equal(title5.id_run, '16074', 'Correctly parses run_id from correctly formed title');
    var title6 = parser.parseIdRun('NPG SeqQC v56.7: Results for run 16074 (current run status: ');
    assert.equal(title6.id_run, '16074', 'Correctly parses run_id from non qc title');
    assert.equal(title6.position, null, 'Correctly sets position as null');
    assert.ok(title6.isRunPage, 'Correctly identifies the page as a single run page');
    var title7 = parser.parseIdRun('NPG SeqQC v56.7: Results (all) for runs 16074 lanes 1');
    assert.equal(title7.id_run, '16074', 'Correctly parses run_id and position from non qc title');
    assert.equal(title7.position, '1', 'Correctly sets position as 1');
    assert.ok(!title7.isRunPage, 'Correctly identifies the page as a run + lane page');
    var title8 = parser.parseIdRun('NPG SeqQC v56.7: Results (all) for runs 16074 lanes 1 2');
    assert.equal(title8, null, 'Can deal with multi lane pages (lexical validation)');
    var title9 = parser.parseIdRun('NPG SeqQC v56.7: Results (all) for runs 16074 16075 lanes 1');
    assert.equal(title9, null, 'Can deal with multi run pages (lexical validation)');
    var title10 = parser.parseIdRun('NPG SeqQC v56.7: Results (all) for runs 16074 16075 lanes 1 2');
    assert.equal(title10, null, 'Can deal with multi run, multi lane pages (lexical validation)');
  });
  
  QUnit.test("NPG.QC.RunPageMQCControl.initQC", function(assert) {
    var data1 = null; 
    var control = new NPG.QC.RunPageMQCControl(new TestConfiguration());
    var returnTrue = function () { return true; };
    var returnFalse = function () { return false; };
    var result1 = control.initQC(data1, null, returnTrue, returnFalse);
    assert.equal(result1, false, 'Control can deal with null data object.');
    data1 = new Object();
    var result2 = control.initQC(data1, null, function () {return true}, function(){return false});
    assert.equal(result2, false, 'Control can deal with empty data object');
    data1.taken_by = 'me';
    data1.current_user = 'me';
    data1.has_manual_qc_role = 1;
    data1.current_status_description = 'qc in progress';
    var result3 = control.initQC(data1, null, function () {return true}, function() {return false});
    assert.equal(result3, true, 'Completes with correct data (qc in progress)');
    data1.current_status_description = 'qc on hold';
    var result31 = control.initQC(data1, null, function () {return true}, function() {return false});
    assert.equal(result31, true, 'Completes with correct data (qc on hold)');
    //
    data1.taken_by = 'other';
    var result4 = control.initQC(data1, null, function () {return true}, function() {return false});
    assert.equal(result4, false, 'Does not run if taken by and current user are different');
    data1.taken_by = 'me';
    //
    data1.current_user = 'other';
    var result5 = control.initQC(data1, null, function () {return true}, function() {return false});
    assert.equal(result5, false, 'Does not run if current user and taken by are different');
    data1.current_user = 'me';
    //
    data1.has_manual_qc_role = '';
    var result6 = control.initQC(data1, null, function () {return true}, function() {return false});
    assert.equal(result6, false, 'Does not run if has manual qc role is not available');
    data1.has_manual_qc_role = 1;
    //
    data1.current_status_description = 'blablabla';
    var result7 = control.initQC(data1, null, function () {return true}, function() {return false});
    assert.equal(result7, false, 'Does not run if current status description is a unexpected one');
    data1.current_status_description = 'qc in progress';
  });
  
  QUnit.test("NPG.QC.RunPageMQCControl.isStateForMQC", function(assert){
    var result = null;
    
    var TAKEN_BY = 'taken_by'; 
    var CURRENT_USER = 'current_user'; 
    var HAS_MANUAL_QC_ROLE = 'has_manual_qc_role';
    var CURRENT_STATUS_DESCRIPTION = 'current_status_description';
    
    var control = new NPG.QC.RunPageMQCControl(new TestConfiguration());
    var ok_taken_by = 'me', ok_current_user = 'me';
    var ok_has_manual_qc_role = 1;
    var ok_current_status_description_1 = 'qc in progress', ok_current_status_description_2 = 'qc on hold';
    
    var createFullObject = function () {
      var theObject = new Object();
      
      theObject[TAKEN_BY] = ok_taken_by;
      theObject[CURRENT_USER] = ok_current_user;
      theObject[HAS_MANUAL_QC_ROLE] = ok_has_manual_qc_role;
      theObject[CURRENT_STATUS_DESCRIPTION] = ok_current_status_description_1;  
      
      return theObject; 
    };
    
    assert.raises(function () { control.isStateForMQC() }, /Error: Invalid arguments/, 'Correctly validates it gets an argument');
    assert.raises(function () { control.isStateForMQC(null) }, /Error: Invalid arguments/, 'Correctly validates it gets an non-null argument');
    var mqc_run_data = Object();
    result = control.isStateForMQC(mqc_run_data);
    assert.equal(result, false, 'Correctly evaluates for an empty data object.');
    
    mqc_run_data = createFullObject();
    assert.equal(control.isStateForMQC(mqc_run_data), true, 'Correctly evaluates for a full object.');
    
    mqc_run_data[CURRENT_STATUS_DESCRIPTION] = ok_current_status_description_2;
    assert.equal(control.isStateForMQC(mqc_run_data), true, 'Correctly evaluates for a full object different current_status_description.');
    
    var all_names = [TAKEN_BY, CURRENT_USER, HAS_MANUAL_QC_ROLE, CURRENT_STATUS_DESCRIPTION];
    for(var i = 0; i < all_names.length; i++) {
      mqc_run_data = createFullObject();
      mqc_run_data[all_names[i]] = null;
      assert.equal(control.isStateForMQC(mqc_run_data), false, 'Correctly evaluates for a full object with null in ' + all_names[i]);
    }
    
    for(var i = 0; i < all_names.length; i++) {
      mqc_run_data = createFullObject();
      mqc_run_data[all_names[i]] = 'xxxxxx';
      assert.equal(control.isStateForMQC(mqc_run_data), false, 'Correctly evaluates for a full object with incorrect value in ' + all_names[i]);
    }
  });
  
  QUnit.test("NPG.QC.RunPageMQCControl.laneOutcomesMatch", function(assert){
    var data1 = null;
    var lanesWithBG = [];
    var control = new NPG.QC.RunPageMQCControl(new TestConfiguration());
    assert.raises(function () {control.laneOutcomesMatch();}, /Error: Invalid arguments/, "Throws exception with invalid number of arguments");
    
    data1 = new Object();
    data1.qc_lane_status = new Object();

    assert.raises(function () {control.laneOutcomesMatch(lanesWithBG);}, /Error: Invalid arguments/, "Throws exception with invalid number of arguments");
    assert.raises(function () {control.laneOutcomesMatch(null, data1);}, /Error: Invalid arguments/, "Throws exception with null arguments");
    assert.raises(function () {control.laneOutcomesMatch(lanesWithBG, null);}, /Error: Invalid arguments/, "Throws exception with null arguments");
    var result = control.laneOutcomesMatch(lanesWithBG, data1);
    assert.equal(result.outcome, true, 'Works with empty lanes in both sides.');
    assert.equal(result.position, null, 'Empty position as there was no error.');
    data1.qc_lane_status[1] = 'Accepted final';
    
    result = control.laneOutcomesMatch(lanesWithBG, data1);
    assert.equal(result.outcome, true, 'Works with mqc status and not matching DWH status.');
    assert.equal(result.position, null, 'Empty position as there was no error.');
    var elements = $('.laneOutcomesMatchTdlanes1').each(function (i, obj) {
      lanesWithBG.push($(obj));  
    });
    
    result = control.laneOutcomesMatch(lanesWithBG, data1);
    assert.equal(result.outcome, true, 'Works with matching in both sides.');
    assert.equal(result.position, null, 'Empty position as there was no error.');
    lanesWithBG = [];
    var elements = $('.laneOutcomesMatchTdlanes2').each(function (i, obj) {
      lanesWithBG.push($(obj));  
    });
    
    result = control.laneOutcomesMatch(lanesWithBG, data1);
    assert.equal(result.outcome, false, 'Correctly validates problems with more outcomesin DWH.');
    assert.equal(result.position, 2, 'Problem is in lane 2');
    data1.qc_lane_status[2] = 'Accepted final';
    
    result = control.laneOutcomesMatch(lanesWithBG, data1);
    assert.equal(result.outcome, true, 'Works with matching in both sides, multiple items');
    assert.equal(result.position, null, 'Empty position as there was no error.');
    lanesWithBG = [];
    var elements = $('.laneOutcomesMatchTdlanes3').each(function (i, obj) {
      lanesWithBG.push($(obj));  
    });
    
    result = control.laneOutcomesMatch(lanesWithBG, data1);
    assert.equal(result.outcome, true, 'Correctly validates problems with unmatching outcomes DWH vs MQC.');
    assert.equal(result.position, null, 'Empty position as there was no error.');
    data1.qc_lane_status[2] = 'Rejected final';
    data1.qc_lane_status[3] = 'Accepted final';
    
    result = control.laneOutcomesMatch(lanesWithBG, data1);
    assert.equal(result.outcome, true, 'Works with more outcomes in MQC than DWH, multiple items');
    assert.equal(result.position, null, 'Empty position as there was no error.');
  });
  
  QUnit.test("NPG.QC.RunPageMQCControl.prepareLanes", function(assert) {
    var control = new NPG.QC.RunPageMQCControl(new TestConfiguration());
    assert.raises(function () {control.prepareLanes();}, /Error: Invalid arguments/, "Throws exception with invalid number of arguments");
    assert.raises(function () {control.prepareLanes(null, null);}, /Error: Invalid arguments/, "Throws exception with both arguments null");
    assert.raises(function () {control.prepareLanes(null, 1);}, /Error: Invalid arguments/, "Throws exception with first argument null");
    assert.raises(function () {control.prepareLanes(1, null);}, /Error: Invalid arguments/, "Throws exception with second argument null");
    
  });
  
  QUnit.test("NPG.QC.RunPageMQCControl.showMQCOutcomes", function(assert) {
    var control = new NPG.QC.RunPageMQCControl(new TestConfiguration());
    assert.raises(function () {control.showMQCOutcomes();}, /Error: Invalid arguments/, "Throws exception with invalid number of arguments");
    assert.raises(function () {control.showMQCOutcomes(null, null);}, /Error: Invalid arguments/, "Throws exception with both arguments null");
    assert.raises(function () {control.showMQCOutcomes(null, 1);}, /Error: Invalid arguments/, "Throws exception with first argument null");
    assert.raises(function () {control.showMQCOutcomes(1, null);}, /Error: Invalid arguments/, "Throws exception with second argument null");
  });
  
</SCRIPT>
</head>
<body>
<h1 id="qunit-header">QUnit Test Suite</h1>
<h2 id="qunit-banner"></h2>
<div id="qunit-testrunner-toolbar"></div>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>

<div id="qunit-fixture">
<div id='mqc_lane1' data-id_run='2' data-position='3' class='lane_mqc_control'><div class='lane_mqc_working'></div></div>
<div id='mqc_lane2' data-id_run='3' data-position='4' data-initial='Accepted final' class='lane_mqc_control'><div class='lane_mqc_working'></div></div>
</div>

<div id="Test_NPG.QC.RunPageMQCControl.laneOutcomesMatch">
<div class='laneOutcomesMatchTdlanes1'><div data-position='1' data-initial='Accepted final' class='lane_mqc_control'></div></div>
<div class='laneOutcomesMatchTdlanes2'><div data-position='1' data-initial='Accepted final' class='lane_mqc_control'></div></div>
<div class='laneOutcomesMatchTdlanes2'><div data-position='2' data-initial='Accepted final' class='lane_mqc_control'></div></div>
<div class='laneOutcomesMatchTdlanes3'><div data-position='1' data-initial='Accepted final' class='lane_mqc_control'></div></div>
<div class='laneOutcomesMatchTdlanes3'><div data-position='2' data-initial='Rejected final' class='lane_mqc_control'></div></div>
</div>

</body>
</html>
