--
-- add columns to the bam_flagstats table
--

ALTER TABLE `bam_flagstats` \
ADD COLUMN `target_autosome_filter` varchar(30) DEFAULT NULL \
 COMMENT 'Filter used to produce the target autosome stats file' \
 AFTER `target_percent_gt_coverage_threshold`,
ADD COLUMN `target_autosome_length` bigint(12) unsigned DEFAULT NULL \
 COMMENT 'The total length of the target autosome regions' \
 AFTER `target_autosome_filter`,
ADD COLUMN `target_autosome_mapped_reads` bigint(20) unsigned DEFAULT NULL \
 COMMENT 'The number of mapped reads passing the filter' \
 AFTER `target_autosome_length`,
ADD COLUMN `target_autosome_proper_pair_mapped_reads` bigint(20) unsigned DEFAULT NULL \
 COMMENT 'The number of proper pair mapped reads passing the filter' \
 AFTER `target_autosome_mapped_reads`, 
ADD COLUMN `target_autosome_mapped_bases` bigint(20) unsigned DEFAULT NULL \
 COMMENT 'The number of mapped bases passing the filter' \
 AFTER `target_autosome_proper_pair_mapped_reads`,
ADD COLUMN `target_autosome_coverage_threshold` int(4) DEFAULT NULL \
 COMMENT 'The coverage threshold used in the perc target autosome greater than depth calculation' \
 AFTER `target_autosome_mapped_bases`,
ADD COLUMN `target_autosome_percent_gt_coverage_threshold` float(5,2) DEFAULT NULL \
 COMMENT 'The percentage of the target autosome covered at greater than the depth specified' \
 AFTER `target_autosome_coverage_threshold`;

--
-- create table for autoqc review criteria
--

CREATE TABLE IF NOT EXISTS `review_criteria` (
  `id_review_criteria` BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT \
    COMMENT 'Auto-generated primary key',
  `checksum` char(32) NOT NULL,
  `library_type` varchar(100) NOT NULL,
  `created_on` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `criteria` text NOT NULL,
  PRIMARY KEY (`id_review_criteria`),
  UNIQUE KEY `review_criteria_uniq` (`checksum`, `library_type`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

--
-- create table for autoqc review result
--

CREATE TABLE IF NOT EXISTS `review` (
  `id_review` BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT \
    COMMENT 'Auto-generated primary key',
  `id_seq_composition` bigint(20) unsigned NOT NULL \
    COMMENT 'A foreign key referencing the id_seq_composition column of the seq_composition table',
  `id_review_criteria` BIGINT(20) UNSIGNED DEFAULT NULL \
    COMMENT 'An optional foreign key referencing the id_review_criteria column of the review_criteria table',
  `evaluation_results` text DEFAULT NULL \
    COMMENT 'A serialized hash mapping individual expressions to their evaluation results',
  `qc_outcome` varchar(256) DEFAULT NULL \
    COMMENT 'A serialized hash representing the manual QC outcome',
  `pass` tinyint(1) DEFAULT NULL,
  `path` varchar(256) DEFAULT NULL,
  `comments` text DEFAULT NULL,
  `info` text,
  PRIMARY KEY (`id_review`),
  UNIQUE KEY `review_id_compos_uniq` (`id_seq_composition`),
  CONSTRAINT `review_compos_fk` FOREIGN KEY (`id_seq_composition`) \
    REFERENCES `seq_composition` (`id_seq_composition`) \
    ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `review_criteria_fk` FOREIGN KEY (`id_review_criteria`) \
    REFERENCES `review_criteria` (`id_review_criteria`) \
    ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=latin1;
